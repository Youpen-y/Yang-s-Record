外围设备（peripherals）—— 扩展计算机功能，与现实世界交互的设备。
输入外设：鼠标、键盘、传感器等
输出外设：显示终端
输入输出外设：网卡

---
操作系统如何与外围设备进行通信？

每个外设都有 registers （至少由三个寄存器组成）和 hardware controller，允许向外设发送 low-level 命令。
hardware controller 是一种电子接口，允许对设备执行命令（如，移动帧、配置设备模式），而寄存器是一种非常昂贵且易失性的存储器，允许几乎即时的信息交换。
- `data` register ，包含操作系统需要知道的一些信息（如，鼠标位置、键入的字符）
- `status` register，用于记录最近是否使用过、是否发生了某些突发错误等
- `control` register，允许向设备发出命令
通过访问这些寄存器中的数据，可以配置、安装和控制任何设备。主要问题是市场上硬件配置多种多样 => 设备驱动程序（device driver）。

设备驱动程序为想要使用、配置和设置外围设备的操作系统和应用程序服务提供了一个上层接口。（技术上，设备驱动程序不过是映射到特定内存位置的程序）。每当操作系统收到使用此类外围设备的请求时，系统都会调用处理程序（即，设备驱动程序），它将提供请求的服务。
两种从外围设备向主计算机共享数据的技术：
- Programmed Input Output (PIO) ，使用 CPU 在内存和外围设备之间传输数据。干扰正常的执行流程。
- Direct Memory Access (DMA) ，对 PIO 的优化，提供不涉及 CPU 的内存与外设的通信。

### PIO
每个数据传输都是由程序中涉及 CPU 的指令启动的。处理器执行一个程序，该程序能直接控制 I/O 操作，包括检测设备的状态、发送 read/write 命令和传输数据。
步骤：
- CPU 正在执行程序并遇到与 I/O 操作相关的指令
- CPU 执行指令，查询外设
- 外设根据 CPU 给出的指令执行请求的操作，并在状态寄存器中设置适当的位
- 处理器会定期检查 I/O 模块的状态，直到检测到操作完成
其中CPU的循环检查操作状态是其主要缺陷，因为 CPU 必须停止执行流才能定期检查外设的状态。
第二个不足时可以发送到 CPU 的数据大小。Registers 固定且体积小，因此 CPU 必须花费几个 clock cycles 才能传输大量数据。
> PIO 速度从 ~KB/s到~55MB/s 不等，对于一些嵌入式设备绰绰有余

此外，不实现 DMA 可以简化 electronic logic （开发成本上的考虑）。
### DMA
要访问 registers ，操作系统和设备必须共享一个公共空间。使用 CPU 已经提供的通用寄存器会占用 CPU 并从根本上停止 OS 进程的执行。解决方案是采用 DMA 设备，允许设备在不查询或中断 CPU 执行流程的情况下访问主内存。

![[PIO vs DMA.png]]
内存允许存储多个 registers，对设备的寄存器数量没有限制。设备的 registers 映射到某个指定地址的内存中，设备驱动程序知道如何操作寄存器和地址位置。

DMA设备控制器 关注将数据从总线（bus, 不同信号流动的通信通道）移动到内存，反之亦然，外设也只需将信号放到总线即可

信号如何从外设到达 DMA 控制器？
主要通过所有外设和主机共享的称为总线（BUS）的通信通道。
三种类型：
- `data bus` - 允许在设备之间共享数据
- `address bus` - 告诉设备数据的目的地
- `control bus` - 协调各种外设之间的活动以防止数据冲突
当外设想要在自己的 register 中写入一些数据时，它使用固定地址，该地址由设备控制器用来在内存中映射该 register 。此操作可由 DMA 控制器或 CPU 本身执行。